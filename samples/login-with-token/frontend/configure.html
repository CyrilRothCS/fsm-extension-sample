<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>login with token</title>
  <link href="https://unpkg.com/fundamental-styles" rel="stylesheet">
</head>
<body>
  <p class="fd-text">Thanks for installing login with token</p>
  <p class="fd-text">Please contact an administrator to configure your account.</p>
  <button id="configure" disabled="disabled" class="fd-button" onClick="openPopup()">Configure</button>
  <script src="https://unpkg.com/fsm-shell"></script>
  <script>

    let openPopup;

    const { ShellSdk, SHELL_EVENTS } = FSMShell;
    // Init ShellSDk
    const shellSdk = ShellSdk.init(window.parent, '*');

    shellSdk.emit(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, {
      clientIdentifier: 'login-token',
      auth: {
        response_type: 'token'  // request a user token within the context
      }
    });

    shellSdk.on(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, async (event) => {
      
      const {
        cloudHost,
        account
      } = JSON.parse(event);

      document.getElementById('configure').disabled = false;

      openPopup = function () {
        const popup = window.open(
          `/configure-popup.html?cloudHost=${cloudHost}&account=${account}`, 
          'configure-popup', 
          'height=270,width=400');
        if (window.focus) {
          popup.focus();
        }

        // When popup close, we refresh the extension to check if configuraiton went well
        popup.onbeforeunload = function(){
          window.location.href = '/';
        }
        return false;
      }
    });
  </script>
</body>
</html>